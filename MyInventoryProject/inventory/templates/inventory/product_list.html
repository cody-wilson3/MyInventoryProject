{% extends "base.html" %}
{% load inventory_extras %}
{% load static %}
{% block title %}Products{% endblock %}
{% block content %}

<div class="header-row">
  <div class="kpi">
    <span class="kpi-label">Grand Total (Price)</span>
    <span class="kpi-value">${{ grand_total|floatformat:2 }}</span>
  </div>
</div>



<form method="get" class="search-row">
  <div class="search-input-wrap">
    <input name="q" value="{{ q }}" placeholder="Search name/SKU/category/tag" autofocus>
    {% if active_tag %}<input type="hidden" name="tag" value="{{ active_tag.name }}">{% endif %}
  </div>

  <button id="tag-filter-btn"
          class="icon-btn{% if active_tag %} is-active{% endif %}"
          type="button"
          aria-label="Filter by tag"
          aria-haspopup="dialog"
          aria-expanded="false"
          aria-controls="tag-popover">
    <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
      <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" fill="currentColor"/>
    </svg>
  </button>

<button id="sort-btn"
        class="icon-btn"
        type="button"
        aria-label="Sort products">
  <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
    {# Up and down arrows to represent sorting #}
    <path d="M7 10l5-5 5 5zM17 14l-5 5-5-5z" fill="currentColor" />
  </svg>
</button>



  {# ‚Üê POPUP LIVES INSIDE THE ROW NOW #}
  <div id="tag-popover" class="filter-popover" role="dialog" hidden>
    <div class="filter-popover-header">
      <strong>Tags</strong>
      <button class="close-btn" type="button" aria-label="Close">&times;</button>
    </div>

    <div class="tag-list">
      <a class="badge" href="{% url 'inventory:product_list' %}{% if q %}?q={{ q|urlencode }}{% endif %}">All</a>
      {% for t in all_tags %}
        {% if active_tag and t.id == active_tag.id %}
          <span class="badge active">{{ t.name }}</span>
        {% else %}
          <a class="badge" href="?tag={{ t.name|urlencode }}{% if q %}&q={{ q|urlencode }}{% endif %}">{{ t.name }}</a>
        {% endif %}
      {% empty %}<em>No tags yet</em>{% endfor %}
    </div>
  </div>
  <div id="sort-popover" class="filter-popover sort-popover" role="dialog" hidden>
  <div class="sort-section">
    <strong class="section-title">Sort by</strong>
    <label class="sort-option">
      <input type="radio" name="sort" value="updated" checked>
      <span>Last updated</span>
    </label>
    <label class="sort-option">
      <input type="radio" name="sort" value="name">
      <span>Name</span>
    </label>
    <label class="sort-option">
      <input type="radio" name="sort" value="quantity">
      <span>Quantity</span>
    </label>
    <label class="sort-option">
      <input type="radio" name="sort" value="price">
      <span>Price</span>
    </label>
  </div>
  <div class="sort-section" style="margin-top:12px;">
    <strong class="section-title">Direction</strong>
    <label class="sort-option">
      <input type="radio" name="direction" value="asc">
      <span>Ascending</span>
    </label>
    <label class="sort-option">
      <input type="radio" name="direction" value="desc" checked>
      <span>Descending</span>
    </label>
  </div>
  <div style="display:flex; justify-content:flex-end; margin-top:14px;">
    <button type="button" class="btn secondary done-btn">Done</button>
  </div>
</div>

</form>

{% if active_tag %}
  <div class="tag-list">
    <span class="badge active">{{ active_tag.name }}</span>
      {% if q or active_tag %}
    <a href="{% url 'inventory:product_list' %}" class="btn secondary clear-btn">Clear</a>
  {% endif %}
  </div>

{% endif %}

</div>


{# --- Standalone items (no group) render as a normal table --- #}
{% if standalone %}
  <h3 style="margin:14px 0 6px">Items</h3>


{# MOBILE PREVIEW LIST (shows only on small screens) #}
<div class="mobile-previews" aria-label="Inventory previews">
  {% for product in standalone %}
    <a class="preview-card"
       href="{% url 'inventory:product_detail' product.id %}"
       title="{{ product.name }}">
      {% if product.image %}
        <img class="preview-thumb" src="{{ product.image.url }}" alt="{{ product.name }}">
      {% else %}
        <img class="preview-thumb" src="{% static 'inventory/placeholder.png' %}" alt="No image">
      {% endif %}

      <div class="preview-main">
        <div class="preview-top">
          <span class="preview-sku">{{ product.sku }}</span>
          <span class="preview-price">
            {% if product.price %}${{ product.price }}{% else %}‚Äî{% endif %}
          </span>
        </div>
        <div class="preview-sub">{{ product.name }}</div>
      </div>
    </a>
  {% empty %}
    <p class="preview-empty">No products found.</p>
  {% endfor %}
</div>




<div class="desktop-table">
  <table class="product-table">
    <thead>
      <tr>
        <th>Image</th>
        <th>SKU</th><th>Name</th><th>Category</th><th>Tags</th>
        <th>On Hand</th><th>Reorder</th><th>Price</th><th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for p in standalone %}
      <tr>
        <td>{% if p.image %}<img src="{{ p.image.url }}" alt="{{ p.name }}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;">{% else %} ‚Äî {% endif %}</td>
        <td><a href="{% url 'inventory:product_detail' p.pk %}">{{ p.sku }}</a></td>
        <td>{{ p.name }}{% if p.website_link %} &nbsp;<a href="{{ p.website_link }}" target="_blank" rel="noopener">üîó</a>{% endif %}</td>
        <td>{{ p.category.name }}</td>
        <td>{% for t in p.tags.all %}<span class="badge">{{ t.name }}</span>{% empty %}<span class="badge">none</span>{% endfor %}</td>
        <td>{{ p.quantity_on_hand }}</td>
        <td>{{ p.reorder_level }}</td>
        <td>${{ p.price|floatformat:2 }}</td>
        <td>{% if p.needs_restock %}<span class="badge restock">Restock</span>{% else %}<span class="badge ok">OK</span>{% endif %}</td>
      </tr>
      {% endfor %}
    <tr>
  <td colspan="7" style="text-align:right; font-weight:bold;">Total:</td>
  <td style="font-weight:bold;">${{ standalone_total|floatformat:2 }}</td>
  <td></td>
</tr>

    </tbody>
  </table>
</div>
{% endif %}

{# --- Headers with children render as collapsible sections --- #}
{% if headers_with_children %}
  <h3 style="margin:18px 0 6px">Groups</h3>
  <div style="display:flex; gap:8px; margin:6px 0 10px">
    <button class="btn secondary" type="button" onclick="document.querySelectorAll('details.group').forEach(d => d.open = true)">Expand all</button>
    <button class="btn secondary" type="button" onclick="document.querySelectorAll('details.group').forEach(d => d.open = false)">Collapse all</button>
  </div>

  {% for p in headers_with_children %}
    <details class="card group" style="margin-bottom:30px" >
      <summary style="display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:600">
        {% if p.image %}
          <img src="{{ p.image.url }}" alt="{{ p.name }}" style="width:42px;height:42px;object-fit:cover;border-radius:6px;">
        {% endif %}
        <span>{{ p.name }}</span>
        <span style="color:var(--muted)">¬∑ {{ p.sku }}</span>
        {% if p.needs_restock %}<span class="badge restock">Restock</span>{% else %}<span class="badge ok">OK</span>{% endif %}
        <span style="margin-left:auto; color:var(--muted)">{{ children_map|get_item:p.id|length }} related</span>
      </summary>

      <div class="table-scroll" style="margin-top:10px">
        <table class="product-table">
          <thead>
            <tr>
              <th>Image</th>
              <th>SKU</th><th>Name</th><th>Category</th><th>Tags</th>
              <th>On Hand</th><th>Reorder</th><th>Price</th><th>Status</th>
            </tr>
          </thead>
          <tbody>
            {# Header as first row #}
            <tr>
              <td>{% if p.image %}<img src="{{ p.image.url }}" alt="{{ p.name }}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;">{% else %} ‚Äî {% endif %}</td>
              <td><a href="{% url 'inventory:product_detail' p.pk %}">{{ p.sku }}</a></td>
              <td><strong>{{ p.name }}</strong>{% if p.website_link %} &nbsp;<a href="{{ p.website_link }}" target="_blank" rel="noopener">üîó</a>{% endif %}</td>
              <td>{{ p.category.name }}</td>
              <td>{% for t in p.tags.all %}<span class="badge">{{ t.name }}</span>{% empty %}<span class="badge">none</span>{% endfor %}</td>
              <td>{{ p.quantity_on_hand }}</td>
              <td>{{ p.reorder_level }}</td>
              <td>${{ p.price|floatformat:2 }}</td>
              <td>{% if p.needs_restock %}<span class="badge restock">Restock</span>{% else %}<span class="badge ok">OK</span>{% endif %}</td>
            </tr>

            {# Children rows #}
            {% for c in children_map|get_item:p.id %}
            <tr>
              <td>{% if c.image %}<img src="{{ c.image.url }}" alt="{{ c.name }}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;">{% else %} ‚Äî {% endif %}</td>
              <td><a href="{% url 'inventory:product_detail' c.pk %}">{{ c.sku }}</a></td>
              <td>{{ c.name }}{% if c.website_link %} &nbsp;<a href="{{ c.website_link }}" target="_blank" rel="noopener">üîó</a>{% endif %}</td>
              <td>{{ c.category.name }}</td>
              <td>{% for t in c.tags.all %}<span class="badge">{{ t.name }}</span>{% empty %}<span class="badge">none</span>{% endfor %}</td>
              <td>{{ c.quantity_on_hand }}</td>
              <td>{{ c.reorder_level }}</td>
              <td>${{ c.price|floatformat:2 }}</td>
              <td>{% if c.needs_restock %}<span class="badge restock">Restock</span>{% else %}<span class="badge ok">OK</span>{% endif %}</td>
            </tr>
            {% endfor %}
          <tr>
  <td colspan="7" style="text-align:right; font-weight:bold;">Group total:</td>
  <td style="font-weight:bold;">${{ group_totals|get_item:p.id|floatformat:2 }}</td>
  <td></td>
</tr>

          </tbody>
        </table>
      </div>
    </details>
  {% endfor %}
{% endif %}



{% endblock %}
